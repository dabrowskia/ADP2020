---
title: "Analiza liczby rozwodów w poszczególnych powiatach."
author: "Natalia Orzechowska, Alicja Lisiecka"
date: "16 czerwca 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(readxl)
library(sf)
library(sqldf)
library(corrplot)
library(Hmisc)
```

## Wstęp
Dane, które zostały wykorzystane do przeprowadzenia analizy pochodzą z Banku Danych Lokalnych. Będziemy badać zależność między liczbą rozwodów a przeciętnym wynagrodzeniem.


## Przygotowanie danych

```{r}
powiaty <- st_read(dsn  = './dane/PRG_jednostki_administracyjne_v40_SZPRG/Powiaty.shp')


y_rozwody <- readxl::read_xlsx('dane/rozwody.xlsx', sheet = 2)

x_ludnosc <- readxl::read_xlsx('dane/ludnosc.xlsx', sheet = 2 )

x_wynagrodzenie <- readxl::read_xlsx('dane/wynagrodzenie.xlsx', sheet = 2)

powiaty$JPT_KOD_JE <- paste0(powiaty$JPT_KOD_JE,'000')



```


```{r}
#łączenie
first_df <- left_join(y_rozwody,select(x_wynagrodzenie,Kod,`przeciętne miesięczne wynagrodzenia brutto w relacji do średniej krajowej (Polska=100)`) , by = "Kod")

first_df <- rename(first_df,liczba_rozwodow = 'ogółem')

first_df <- left_join(first_df,select(x_ludnosc,Kod,'ogółem') , by = "Kod")

first_df <- rename(first_df,liczba_ludnosci = 'ogółem')

first_df <- first_df[!is.na(first_df$Kod),]
```


```{r}
# na numeryczne 
first_df$liczba_rozwodow = as.numeric(as.character(first_df$liczba_rozwodow ))

first_df$liczba_ludnosci = as.numeric(as.character(first_df$liczba_ludnosci ))

first_df$`przeciętne miesięczne wynagrodzenia brutto w relacji do średniej krajowej (Polska=100)` = 

as.numeric(as.character(first_df$`przeciętne miesięczne wynagrodzenia brutto w relacji do średniej krajowej (Polska=100)` ))

```


```{r}
# scalowanie

first_df <- first_df %>% mutate(liczba_rozwodow = (liczba_rozwodow/liczba_ludnosci*100))
```

```{r}
##View(first_df)
```


```{r}
# zmiana nazwy zeby mialo sens
first_df <-rename(first_df,liczba_rozwodow_w_stosunku_do_liczby_ludnosci = liczba_rozwodow)

```



```{r}
dane_z_sf <-  powiaty %>% left_join(first_df, by = c ( 'JPT_KOD_JE' = 'Kod'))
```

## Powiaty o największym procencie rozwodów względem liczby ludności.

Najwięcej rozwodów w 2018 roku odnotowano w powiecie legionowskim (3 rozwody na 1000 osób). Na drugim miejscu jest m. Leszno (2,6/1000 os.) oraz m. Jastrzębie-Zdrój (2,5/1000 os.) Najmniej rozwódów zanotowano w powiecie janowskim (0,6/1000 os.)
```{r}
first_df %>%
  arrange(desc(liczba_rozwodow_w_stosunku_do_liczby_ludnosci))
```

Poniżej mapa przedstawiająca zróźnicowanie rozwodów w poszczególnych powiatach.
```{r}
#przyklad sprawdzam czy działa
ggplot(dane_z_sf,aes(fill = liczba_rozwodow_w_stosunku_do_liczby_ludnosci )) + geom_sf()+
  scale_fill_gradient( low = 'white' ,  high = 'red')
```



```{r}
# ogarniamy rozwody w wojewodztwach
wojewodztwa <- first_df %>% select(Nazwa,Kod) %>% 
  filter(Nazwa == toupper(Nazwa))
wojewodztwa <- wojewodztwa[-1,]
wojewodztwa$woj <- (substr(wojewodztwa$Kod,1,2))
```

```{r}
first_df$woj <- 'text'
first_df$woj <- (substr(first_df$Kod,1,2))

first_df<-merge(first_df,wojewodztwa,by = "woj",all.x = TRUE)

first_df$Kod.y <- NULL
first_df <- rename(first_df,wojewodztwo = Nazwa.y)
```



```{r}
srednie_zarobki_wojewodztwa <- first_df %>% group_by(wojewodztwo) %>%
  summarise(srednie_zarobki = mean(`przeciętne miesięczne wynagrodzenia brutto w relacji do średniej krajowej (Polska=100)`))

srednie_zarobki_wojewodztwa <- na.omit(srednie_zarobki_wojewodztwa)

srednia_liczba_rozwodow <- first_df %>% group_by(wojewodztwo) %>%summarise( srednia_liczba_rozwodow_w_stosunku_do_ll = mean(liczba_rozwodow_w_stosunku_do_liczby_ludnosci))

srednia_liczba_rozwodow <- na.omit(srednia_liczba_rozwodow)
```


```{r}
#zarobki w powiatach
#ggplot(dane_z_sf,aes(fill = 'przeciętne miesięczne wynagrodzenia brutto w relacji do średniej krajowej (Polska=100)' )) + geom_sf()+
  #scale_fill_gradient( low = 'white' ,  high = 'dark green')

```

## Średnia wysokość zarobków w województwach

```{r}
#View(srednie_zarobki_wojewodztwa) 

srednie_zarobki_wojewodztwa %>%
  arrange(desc(srednie_zarobki))
  
```
Największe średnie zarobki są w woj. śląskim, najmniejsze natomiast w woj. warmińsko-mazurskim.

Poniższy wykres przedstawia średnie zarobki w poszczególnych województwach.
```{r}
ggplot(srednie_zarobki_wojewodztwa,aes(x = wojewodztwo,y = srednie_zarobki))+
  geom_bar(stat="identity", fill = 'green') + 
  ylab("średnie miesięczne zarobki")+
  ggtitle("Średnia wysokość zarobków w województwach")+
  theme(axis.text.x=element_text(angle =- 90, vjust = 0.5))
```


Poniższy wykres przedstawia średnią liczbę rozwodóW w poszczególnych województwach.
```{r}
ggplot(srednia_liczba_rozwodow,aes(x = wojewodztwo,y = srednia_liczba_rozwodow_w_stosunku_do_ll))+
  geom_bar(stat="identity", fill = 'red') + 
  ylab("Średnia liczba rozwodów")+
  theme(axis.text.x=element_text(angle =- 90, vjust = 0.5))
```

# Zależność między procentem rozwodów  a przeciętnym miesięczym wynagrodzeniem.
```{r}
posortowane_rozwody <- first_df[order(first_df$liczba_rozwodow_w_stosunku_do_liczby_ludnosci),]

ggplot(first_df,aes(x = first_df$`przeciętne miesięczne wynagrodzenia brutto w relacji do średniej krajowej (Polska=100)`,
                    y = first_df$liczba_rozwodow_w_stosunku_do_liczby_ludnosci)) +
      geom_point() +
    geom_smooth(method = "lm")

#View(posortowane_rozwody)
```


# Gęstość
```{r}
#denisty

 ggplot(first_df, aes(x=first_df$liczba_rozwodow_w_stosunku_do_liczby_ludnosci)) + 
  geom_density(fill="lightblue") +
   geom_vline(aes(xintercept=mean(first_df$liczba_rozwodow_w_stosunku_do_liczby_ludnosci)),
              color="blue", linetype="dashed", size=1)

 ggplot(first_df, aes(x=first_df$`przeciętne miesięczne wynagrodzenia brutto w relacji do średniej krajowej (Polska=100)`)) + 
   geom_density(fill="lightgreen") +
   geom_vline(aes(xintercept=mean(first_df$`przeciętne miesięczne wynagrodzenia brutto w relacji do średniej krajowej (Polska=100)`)),
              color="blue", linetype="dashed", size=1)
```

#Dopasowanie modelu
```{r}
 simple.fit = lm(liczba_rozwodow_w_stosunku_do_liczby_ludnosci~`przeciętne miesięczne wynagrodzenia brutto w relacji do średniej krajowej (Polska=100)`, data=first_df)
 summary(simple.fit)
``` 
 

#Współczynnik Pearsona

```{r}
cor.test(first_df$liczba_rozwodow_w_stosunku_do_liczby_ludnosci, first_df$`przeciętne miesięczne wynagrodzenia brutto w relacji do średniej krajowej (Polska=100)`)
```
Aby poznać zależność między średnim wynagrodzeniem mieszkańców, a liczbą rozwodów, zastosowana współczynnik Pearsona. Jego wartość wynosi ok. 0,42, a więc zależność między zmiennymi można raczej uznać za słabą. Znak przy współczynniku Pearsona jest dodatni, co oznacza, że im wyższe wynagrodzenie, tym wyższa liczba rozwodów. Ponadto, wyliczona p-wartość (p-value) jest mniejsza niż 0,05, co oznacza, iż zmienna objaśniająca (przeciętne miesięczne wynag brutto) jest istotna.





